services:
  product:
    build: ./cinch-products
    volumes:
      - ./cinch-products:/var/www
    networks:
      - ecommerce

  product-nginx:
    build:
      context: ./cinch-products
      dockerfile: Dockerfile.nginx
    ports:
      - "8001:80"
    depends_on:
      - product
    volumes:
      - ./cinch-products:/var/www
    networks:
      - ecommerce

  checkout:
    build: ./cinch-checkout
    volumes:
      - ./cinch-checkout:/var/www
    networks:
      - ecommerce

  checkout-nginx:
    build:
      context: ./cinch-checkout
      dockerfile: Dockerfile.nginx
    ports:
      - "8002:80"
    depends_on:
      - checkout
    volumes:
      - ./cinch-checkout:/var/www
    networks:
      - ecommerce

  email:
    build: ./cinch-mailer
    volumes:
      - ./cinch-mailer:/var/www
    networks:
      - ecommerce

  email-nginx:
    build:
      context: ./cinch-mailer
      dockerfile: Dockerfile.nginx
    ports:
      - "8003:80"
    depends_on:
      - email
    volumes:
      - ./cinch-mailer:/var/www
    networks:
      - ecommerce

  redis:
    image: redis:alpine
    networks:
      - ecommerce

  email-worker:
    build: ./cinch-mailer
    command: php artisan queue:work --verbose --tries=3 --timeout=90
    restart: unless-stopped
    volumes:
      - ./cinch-mailer:/var/www
    depends_on:
      - email
      - redis
    networks:
      - ecommerce

  frontend:
    build: ./cinch-frontend
    ports:
      - "80:80"
    depends_on:
      - product-nginx
      - checkout-nginx
    networks:
      - ecommerce

  db:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ecommerce
      MYSQL_USER: ecommerce_user
      MYSQL_PASSWORD: secret
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - ecommerce

  mailhog:
    image: mailhog/mailhog
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - ecommerce

networks:
  ecommerce:

volumes:
  db_data:
